name: Firestore Backup

on:
  # Run daily at 2 AM SGT (UTC+8) = 18:00 UTC
  schedule:
    - cron: "0 18 * * *"
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  backup:
    name: Backup Firestore to Private Repo
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codebase repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install firebase-admin
        run: npm install firebase-admin --prefix ./scripts

      - name: Run backup script
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        run: node scripts/backup-firestore.js

      - name: Clone or init backup repo
        run: |
          REPO_URL="https://x-access-token:${{ secrets.BACKUP_REPO_PAT }}@github.com/${{ secrets.BACKUP_REPO }}.git"
          if git clone --depth 1 "$REPO_URL" backup-repo 2>/dev/null; then
            echo "âœ… Cloned existing backup repo"
          else
            echo "âš ï¸  Backup repo is empty â€” initialising fresh"
            mkdir -p backup-repo
            cd backup-repo
            git init
            git checkout -b main
            git remote add origin "$REPO_URL"
          fi

      - name: Copy backup files to backup repo
        run: |
          DATE=$(date -u +"%Y-%m-%d")
          mkdir -p backup-repo/backups/$DATE
          cp -r backups/$DATE/. backup-repo/backups/$DATE/

      - name: Commit and push to backup repo
        run: |
          DATE=$(date -u +"%Y-%m-%d")
          REPO_URL="https://x-access-token:${{ secrets.BACKUP_REPO_PAT }}@github.com/${{ secrets.BACKUP_REPO }}.git"
          cd backup-repo
          git config user.name "MMS Backup Bot"
          git config user.email "backup-bot@mms.local"
          git remote set-url origin "$REPO_URL"
          git checkout -B main 2>/dev/null || true
          git add backups/
          git diff --cached --quiet || git commit -m "ğŸ—„ï¸ Automated backup â€” $DATE"
          git push origin main --set-upstream
